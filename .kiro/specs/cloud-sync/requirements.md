# 跨端数据同步 - 需求文档

## 1. 功能概述

为 BovaPlayer 添加用户账号系统和云端数据同步功能，让用户可以在多个设备间同步 Emby 服务器列表、播放历史、收藏等数据。

## 2. 用户故事

### 2.1 用户注册
**作为** 新用户  
**我想要** 注册一个 BovaPlayer 账号  
**以便** 使用云端同步功能

**验收标准：**
- 支持邮箱注册
- 支持第三方登录（Google/Apple）
- 密码强度验证
- 邮箱验证
- 注册成功后自动登录

### 2.2 用户登录
**作为** 已注册用户  
**我想要** 在新设备上登录我的账号  
**以便** 访问我的同步数据

**验收标准：**
- 支持邮箱/密码登录
- 支持第三方登录
- 记住登录状态
- 支持退出登录
- 支持找回密码

### 2.3 Emby 服务器同步
**作为** 用户  
**我想要** 添加的 Emby 服务器自动同步到云端  
**以便** 在其他设备上也能看到相同的服务器列表

**验收标准：**
- 添加 Emby 服务器后自动上传到云端
- 登录后自动下载服务器列表
- 支持多设备实时同步
- 删除服务器时同步删除
- 修改服务器信息时同步更新

### 2.4 播放历史同步
**作为** 用户  
**我想要** 播放历史在多设备间同步  
**以便** 在任何设备上继续观看

**验收标准：**
- 播放位置自动同步
- 观看历史记录同步
- 支持断点续播
- 显示最近观看列表

### 2.5 收藏和设置同步
**作为** 用户  
**我想要** 收藏的内容和应用设置同步  
**以便** 在所有设备上保持一致的体验

**验收标准：**
- 收藏列表同步
- 播放器设置同步
- 主题偏好同步
- 字幕设置同步

## 3. 技术需求

### 3.1 后端服务选择

#### 方案 A: Supabase (推荐)
**优点：**
- 开箱即用的认证系统
- 实时数据库同步
- 免费额度充足
- Flutter SDK 完善
- 开源可自建

**功能：**
- 用户认证（邮箱、OAuth）
- PostgreSQL 数据库
- 实时订阅
- 行级安全策略
- 文件存储

#### 方案 B: Firebase
**优点：**
- Google 官方支持
- Flutter 集成完善
- 实时同步快速

**缺点：**
- 闭源
- 数据在 Google 服务器

#### 方案 C: 自建后端
**优点：**
- 完全控制
- 数据隐私

**缺点：**
- 开发成本高
- 维护成本高

### 3.2 数据模型

#### 用户表 (users)
```sql
- id: UUID (主键)
- email: String (唯一)
- username: String
- avatar_url: String
- created_at: Timestamp
- updated_at: Timestamp
```

#### Emby 服务器表 (emby_servers)
```sql
- id: UUID (主键)
- user_id: UUID (外键)
- name: String
- url: String
- access_token: String (加密)
- user_id_emby: String
- created_at: Timestamp
- updated_at: Timestamp
- is_active: Boolean
```

#### 播放历史表 (play_history)
```sql
- id: UUID (主键)
- user_id: UUID (外键)
- server_id: UUID (外键)
- item_id: String (Emby item ID)
- item_name: String
- item_type: String (Movie/Episode)
- position: Integer (秒)
- duration: Integer (秒)
- last_played: Timestamp
- thumbnail_url: String
```

#### 收藏表 (favorites)
```sql
- id: UUID (主键)
- user_id: UUID (外键)
- server_id: UUID (外键)
- item_id: String
- item_name: String
- item_type: String
- created_at: Timestamp
```

#### 用户设置表 (user_settings)
```sql
- id: UUID (主键)
- user_id: UUID (外键)
- settings_json: JSONB
- updated_at: Timestamp
```

### 3.3 安全策略

#### 行级安全 (RLS)
- 用户只能访问自己的数据
- Emby token 加密存储
- API 密钥保护

#### 数据加密
- 传输加密 (HTTPS)
- 敏感数据加密存储
- Token 加密

## 4. UI/UX 设计

### 4.1 账号页面
- 登录/注册入口
- 用户信息展示
- 同步状态显示
- 退出登录

### 4.2 Emby 服务器管理
- 服务器列表（带同步状态）
- 添加/编辑/删除服务器
- 同步指示器
- 冲突解决

### 4.3 播放历史页面
- 最近观看列表
- 继续观看入口
- 跨设备标识

### 4.4 设置页面
- 同步开关
- 同步频率设置
- 数据管理（清除缓存等）

## 5. 实现阶段

### 阶段 1: 基础认证 (1-2周)
- [ ] 集成 Supabase
- [ ] 实现注册/登录 UI
- [ ] 邮箱认证
- [ ] 本地状态管理

### 阶段 2: Emby 服务器同步 (1周)
- [ ] 数据库表设计
- [ ] 服务器列表同步
- [ ] 实时更新
- [ ] 冲突处理

### 阶段 3: 播放历史同步 (1周)
- [ ] 播放历史上传
- [ ] 断点续播
- [ ] 历史列表 UI

### 阶段 4: 高级功能 (1-2周)
- [ ] 收藏同步
- [ ] 设置同步
- [ ] 第三方登录
- [ ] 数据导出

## 6. 非功能需求

### 6.1 性能
- 同步延迟 < 2秒
- 离线模式支持
- 增量同步

### 6.2 可靠性
- 数据冲突解决
- 自动重试机制
- 数据备份

### 6.3 隐私
- 用户数据加密
- 可选择性同步
- 数据删除功能

## 7. 技术风险

### 7.1 数据冲突
- **风险**: 多设备同时修改数据
- **缓解**: 使用时间戳和版本号解决冲突

### 7.2 网络依赖
- **风险**: 无网络时无法同步
- **缓解**: 实现离线模式和队列机制

### 7.3 成本控制
- **风险**: 用户增长导致成本上升
- **缓解**: 使用免费额度，必要时收费

## 8. 依赖项

- Supabase Flutter SDK
- 本地数据库 (SQLite)
- 加密库
- 状态管理 (Provider/Riverpod)

## 9. 测试计划

### 9.1 功能测试
- 注册/登录流程
- 数据同步测试
- 冲突解决测试

### 9.2 性能测试
- 大量数据同步
- 并发同步测试
- 网络异常测试

### 9.3 安全测试
- 认证安全测试
- 数据加密验证
- 权限控制测试

## 10. 成本估算

### Supabase 免费额度
- 数据库: 500MB
- 存储: 1GB
- 带宽: 2GB/月
- 认证用户: 50,000

**预估**: 免费额度足够支持 1000+ 活跃用户

### 付费计划 (如需)
- Pro: $25/月
- 支持更多用户和存储
