# SMB 和 FTP 协议支持 - 需求文档

## 1. 功能概述

为 BovaPlayer 本地播放功能添加 SMB (Samba) 和 FTP (File Transfer Protocol) 协议支持，让用户可以浏览和播放网络共享目录中的视频文件。

## 2. 用户故事

### 2.1 SMB 目录浏览和播放
**作为** 用户  
**我想要** 连接到 SMB 共享目录并浏览其中的视频文件  
**以便** 直接播放局域网 NAS 上的视频，无需下载

**验收标准：**
- 用户可以输入 SMB 服务器地址（如 `smb://192.168.1.100/videos`）
- 支持 SMB 认证（用户名/密码）
- 可以浏览 SMB 共享目录结构
- 显示文件夹和视频文件列表
- 点击视频文件直接播放
- 支持返回上级目录
- 显示连接状态和错误提示
- 记住最近连接的服务器

### 2.2 FTP 目录浏览和播放
**作为** 用户  
**我想要** 连接到 FTP 服务器并浏览视频文件  
**以便** 播放 FTP 服务器上的视频内容

**验收标准：**
- 用户可以输入 FTP 服务器地址（如 `ftp://192.168.1.100:21`）
- 支持 FTP 认证（用户名/密码）
- 支持匿名 FTP 访问
- 可以浏览 FTP 目录结构
- 显示文件夹和视频文件列表
- 点击视频文件直接播放
- 支持被动模式和主动模式
- 显示连接状态和传输进度

### 2.3 协议选择和切换
**作为** 用户  
**我想要** 在本地播放页面选择不同的协议  
**以便** 根据场景选择最合适的访问方式

**验收标准：**
- 本地播放页面增加协议选择（本地文件/SMB/FTP/HTTP）
- 根据协议显示不同的输入界面
- 保存最近使用的连接
- 支持快速切换协议
- 显示当前使用的协议

### 2.4 文件过滤和搜索
**作为** 用户  
**我想要** 在网络目录中快速找到视频文件  
**以便** 提高浏览效率

**验收标准：**
- 自动过滤显示视频文件（mp4, mkv, avi, mov 等）
- 支持文件名搜索
- 显示文件大小和修改时间
- 支持排序（名称、大小、时间）

## 3. 技术需求

### 3.1 SMB 协议支持
**Flutter 插件选择：**
- **主选**: `dart_smb` 或 `flutter_smb`
- **备选**: 原生代码实现（Android: jcifs-ng, iOS: libsmb2）

**功能需求：**
- SMB 2.0/3.0 协议支持
- 连接管理和认证
- 目录遍历
- 文件元数据读取（大小、时间）
- 文件流读取（用于播放）
- 连接池管理
- 超时和重连机制

### 3.2 FTP 协议支持
**Flutter 插件选择：**
- **主选**: `ftpconnect` 或 `dart_ftp`
- **备选**: 原生 FTP 客户端

**功能需求：**
- FTP/FTPS 协议支持
- 主动模式和被动模式
- 匿名和认证访问
- 目录列表（LIST 命令）
- 文件下载流
- 断点续传支持
- 连接保活

### 3.3 Media Kit 集成
**播放器适配：**
- 将 SMB/FTP 文件流转换为 Media Kit 可识别的格式
- 方案 1: 本地代理服务器（推荐）
  - 启动本地 HTTP 服务器
  - SMB/FTP 文件通过代理转发
  - Media Kit 播放 `http://localhost:port/file`
- 方案 2: 直接文件流
  - 下载到临时文件
  - Media Kit 播放本地文件

### 3.4 UI 组件

#### 协议选择器
```dart
enum NetworkProtocol {
  local,    // 本地文件
  smb,      // SMB/CIFS
  ftp,      // FTP/FTPS
  http,     // HTTP/HTTPS
}
```

#### SMB 连接配置
- 服务器地址
- 端口（默认 445）
- 共享名称
- 用户名
- 密码
- 工作组（可选）

#### FTP 连接配置
- 服务器地址
- 端口（默认 21）
- 用户名
- 密码
- 传输模式（主动/被动）
- 加密（FTP/FTPS）

#### 文件浏览器
- 面包屑导航
- 文件/文件夹列表
- 文件图标（视频/文件夹）
- 文件信息（大小、时间）
- 加载状态
- 错误提示

## 4. 非功能需求

### 4.1 性能
- 目录加载时间 < 2秒
- 文件播放启动延迟 < 3秒
- 支持大文件流式播放（不需要完整下载）
- 缓冲策略优化（预读 10-20MB）
- 内存占用 < 100MB

### 4.2 安全
- 密码加密存储（使用 flutter_secure_storage）
- 支持 SMB 加密传输（SMB 3.0）
- 支持 FTPS（FTP over SSL/TLS）
- 不在日志中输出敏感信息

### 4.3 兼容性
- 支持 SMB 2.0/3.0 协议
- 支持主流 NAS 系统：
  - 群晖 (Synology)
  - 威联通 (QNAP)
  - Windows 共享
  - Linux Samba
- 支持标准 FTP 服务器
- 跨平台支持（Android/iOS/macOS/Windows）

### 4.4 用户体验
- 连接失败时显示清晰的错误信息
- 支持后台连接（不阻塞 UI）
- 显示加载进度
- 支持取消操作
- 记住用户配置

## 5. 实现优先级

### P0 (必须有 - MVP)
- SMB 基本连接和认证
- SMB 目录浏览
- SMB 文件播放
- FTP 基本连接和认证
- FTP 目录浏览
- FTP 文件播放
- 协议选择 UI
- 基本错误处理

### P1 (应该有 - V1.0)
- 连接历史记录
- 文件搜索和过滤
- 连接状态指示
- 自动重连机制
- 播放进度保存
- 文件信息显示

### P2 (可以有 - V1.1+)
- FTPS 支持
- SMB 3.0 加密
- 批量操作
- 文件缓存
- 离线下载
- 高级配置选项

## 6. 技术风险

### 6.1 SMB/FTP 插件成熟度
- **风险**: Flutter 的 SMB/FTP 插件可能不够成熟或功能不完整
- **缓解**: 
  - 评估多个插件（ftpconnect, dart_ftp, dart_smb）
  - 准备原生代码实现方案
  - 考虑使用本地代理服务器方案

### 6.2 Media Kit 协议支持
- **风险**: Media Kit 可能不直接支持 SMB/FTP 协议
- **缓解**: 
  - 使用本地 HTTP 代理服务器
  - 将 SMB/FTP 流转换为 HTTP 流
  - 或下载到临时文件播放

### 6.3 跨平台差异
- **风险**: 不同平台的 SMB/FTP 实现可能不同
- **缓解**: 
  - 使用统一的抽象层
  - 针对不同平台做适配
  - 充分测试各平台兼容性

### 6.4 网络性能
- **风险**: 网络波动导致播放卡顿
- **缓解**: 
  - 实现智能缓冲策略
  - 支持断点续传
  - 显示网络状态和速度

### 6.5 NAS 兼容性
- **风险**: 不同 NAS 系统的 SMB 实现可能有差异
- **缓解**: 
  - 测试主流 NAS 系统
  - 提供兼容性配置选项
  - 收集用户反馈持续优化

## 7. 依赖项

### Flutter 包
- `ftpconnect: ^2.0.0` - FTP 客户端
- `dart_smb` 或 `flutter_smb` - SMB 客户端
- `flutter_secure_storage: ^9.0.0` - 密码加密存储
- `path: ^1.8.0` - 路径处理
- `mime: ^1.0.0` - 文件类型识别
- `shelf: ^1.4.0` - 本地 HTTP 代理服务器（可选）

### 系统权限
- 网络访问权限
- 本地存储权限（临时文件）

### 现有组件
- Media Kit 播放器
- 本地文件选择器
- 播放位置记忆功能

## 8. 测试计划

### 8.1 单元测试
- SMB 连接和认证测试
- FTP 连接和认证测试
- 目录解析测试
- 文件过滤测试
- URL 解析测试
- 配置管理测试

### 8.2 集成测试
- 端到端播放测试
- 不同 NAS 系统兼容性测试：
  - 群晖 DSM
  - 威联通 QTS
  - Windows 共享
  - Linux Samba
- FTP 服务器兼容性测试
- 网络异常处理测试
- 协议切换测试

### 8.3 性能测试
- 大文件播放测试（4K 视频）
- 目录加载性能测试（1000+ 文件）
- 网络波动测试
- 并发连接测试
- 内存泄漏测试

### 8.4 用户体验测试
- 连接流程测试
- 错误提示清晰度
- 加载状态反馈
- 操作响应速度

## 9. 实现里程碑

### 里程碑 1: 技术验证 (1周)
- [ ] 评估 SMB/FTP Flutter 插件
- [ ] 实现 SMB 基本连接
- [ ] 实现 FTP 基本连接
- [ ] 验证 Media Kit 集成方案
- [ ] 决定最终技术方案

### 里程碑 2: MVP 实现 (2-3周)
- [ ] 实现协议选择 UI
- [ ] 实现 SMB 目录浏览
- [ ] 实现 FTP 目录浏览
- [ ] 实现文件播放功能
- [ ] 基本错误处理
- [ ] 内部测试

### 里程碑 3: 完善功能 (1-2周)
- [ ] 连接历史记录
- [ ] 文件搜索和过滤
- [ ] 连接状态优化
- [ ] 性能优化
- [ ] 用户测试和反馈

### 里程碑 4: 发布准备 (1周)
- [ ] 完整测试
- [ ] 文档编写
- [ ] 发布说明
- [ ] 版本发布

**总计**: 约 5-7周完整实现
