name: Build All Platforms

on:
  push:
    tags: 
      - 'v*'              # æ‰€æœ‰ v* tag éƒ½ä¼šè§¦å‘
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    inputs:
      platforms:
        description: 'é€‰æ‹©è¦æ„å»ºçš„å¹³å° (all/windows/macos/android)'
        required: false
        default: 'all'

jobs:
  # ============================================================
  #  Windows æ„å»º (Flutter + MDK)
  # ============================================================
  build-windows:
    if: |
      (github.event_name == 'push' && !contains(github.ref, '-android') && !contains(github.ref, '-macos')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows'))
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: Build Windows (Flutter)
        run: |
          cd ui/flutter_app
          flutter pub get
          flutter build windows --release

      - name: æ•´ç†å‘å¸ƒäº§ç‰©
        shell: pwsh
        run: |
          mkdir release
          Copy-Item "ui\flutter_app\build\windows\x64\runner\Release\*" -Destination "release" -Recurse
          Compress-Archive -Path release\* -DestinationPath BovaPlayer-Windows.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-Windows
          path: BovaPlayer-Windows.zip

  # ============================================================
  # ============================================================
  #  macOS æ„å»º (Flutter + MDK)
  # ============================================================
  build-macos:
    if: |
      (github.event_name == 'push' && !contains(github.ref, '-android') && !contains(github.ref, '-windows')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos'))
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: Build macOS (Flutter)
        run: |
          cd ui/flutter_app
          flutter pub get
          flutter build macos --release

      - name: åˆ›å»º DMG
        run: |
          hdiutil create -volname "BovaPlayer" \
            -srcfolder ui/flutter_app/build/macos/Build/Products/Release/BovaPlayer.app \
            -ov -format UDZO \
            BovaPlayer-macOS.dmg

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-macOS
          path: BovaPlayer-macOS.dmg

  # ============================================================
  #  Android æ„å»º (Flutter + Rust FFI)
  # ============================================================
  build-android:
    # åªåœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
    # 1. tag ä¸åŒ…å« -windows æˆ– -macos
    # 2. æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† android æˆ– all
    if: |
      (github.event_name == 'push' && !contains(github.ref, '-windows') && !contains(github.ref, '-macos')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'android'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'
          cache: true

      - name: ç¼“å­˜ Gradle ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ui/flutter_app/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ç¼“å­˜ pub ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Flutter ä¾èµ–å®‰è£…
        run: |
          cd ui/flutter_app
          # åªåœ¨å¿…è¦æ—¶æ¸…ç†
          rm -rf build
          # ç¡®ä¿ local.properties å­˜åœ¨å¹¶åŒ…å«æ­£ç¡®çš„ Flutter SDK è·¯å¾„
          echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
          echo "sdk.dir=$ANDROID_HOME" >> android/local.properties
          # å®‰è£…ä¾èµ–
          flutter pub get
          # æ˜¾ç¤ºå®é™…å®‰è£…çš„ç‰ˆæœ¬
          echo "=== å·²å®‰è£…çš„ media_kit ç›¸å…³åŒ…ç‰ˆæœ¬ ==="
          flutter pub deps | grep media_kit || true

      - name: ä¿®è¡¥ media_kit_videoï¼ˆæ·»åŠ  onSurfaceDestroyed æ–¹æ³•ï¼‰
        run: |
          cd ui/flutter_app
          
          # æå– pub cache ç›®å½•å¹¶é€šè¿‡ python è„šæœ¬ç²¾å‡†ä¿®è¡¥
          python -c '
          import os, glob
          
          pub_cache = os.path.expanduser("~/.pub-cache")
          search_pattern = os.path.join(pub_cache, "**", "media_kit_video", "android", "**", "VideoOutput.java")
          import glob
          files = glob.glob(search_pattern, recursive=True)
          
          for file_path in files:
              print(f"æ£€æŸ¥æ–‡ä»¶: {file_path}")
              with open(file_path, "r", encoding="utf-8") as f:
                  content = f.read()
              
              if "onSurfaceDestroyed" in content:
                  print("âœ“ onSurfaceDestroyed æ–¹æ³•å·²å­˜åœ¨")
                  continue
                  
              print(f"éœ€è¦æ·»åŠ  onSurfaceDestroyed æ–¹æ³•åˆ°: {file_path}")
              
              # 1. ç§»é™¤ public void onSurfaceCleanup() ç´§é‚»ä¸Šæ–¹çš„ @Override
              # ä½¿ç”¨ replace æ›¿æ¢ç²¾ç¡®çš„æ–¹æ³•ç­¾å
              import re
              content = re.sub(r"@Override\s+public void onSurfaceCleanup\(\)", "public void onSurfaceCleanup()", content)
              
              # 2. åœ¨æ–‡ä»¶æœ«å°¾çš„ } å‰æ’å…¥ onSurfaceDestroyed
              injection = """
    public void onSurfaceDestroyed() {
        onSurfaceCleanup();
    }
}"""
              content = re.sub(r"}\s*$", injection, content)
              
              with open(file_path, "w", encoding="utf-8") as f:
                  f.write(content)
              
              print("âœ“ å·²ç²¾å‡†ä¿®å¤æ–‡ä»¶")
          '

      - name: æ„å»º APK
        run: |
          cd ui/flutter_app
          # æ„å»ºåŒ…å«æ‰€æœ‰æ¶æ„çš„é€šç”¨ APK
          flutter build apk --release
          cp build/app/outputs/flutter-apk/app-release.apk ../../BovaPlayer-Android.apk

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-Android
          path: BovaPlayer-Android.apk

  # ============================================================
  #  åˆ›å»º Releaseï¼ˆä»…åœ¨æ¨é€ tag æ—¶è§¦å‘ï¼‰
  # ============================================================
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && always()
    needs: [build-windows, build-macos, build-android]
    # å³ä½¿æŸäº› job è¢«è·³è¿‡ä¹Ÿç»§ç»­æ‰§è¡Œ
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          # åªå¤åˆ¶å­˜åœ¨çš„æ–‡ä»¶
          [ -f artifacts/BovaPlayer-Windows/BovaPlayer-Windows.zip ] && cp artifacts/BovaPlayer-Windows/BovaPlayer-Windows.zip release-files/ || echo "âš ï¸ Windows æ„å»ºä¸å­˜åœ¨"
          [ -f artifacts/BovaPlayer-macOS/BovaPlayer-macOS.dmg ] && cp artifacts/BovaPlayer-macOS/BovaPlayer-macOS.dmg release-files/ || echo "âš ï¸ macOS æ„å»ºä¸å­˜åœ¨"
          [ -f artifacts/BovaPlayer-Android/BovaPlayer-Android.apk ] && cp artifacts/BovaPlayer-Android/BovaPlayer-Android.apk release-files/ || echo "âš ï¸ Android æ„å»ºä¸å­˜åœ¨"
          ls -la release-files/
          
      - name: ç”Ÿæˆ Release è¯´æ˜
        id: release_notes
        run: |
          TAG_NAME="${{ github.ref_name }}"
          
          # è·å– tag çš„å®Œæ•´ messageï¼ˆåŒ…å«å¤šè¡Œï¼‰
          TAG_MESSAGE=$(git tag -l --format='%(contents)' "${TAG_NAME}")
          
          # å¼€å§‹æ„å»º Release Notes
          NOTES="## BovaPlayer ${TAG_NAME}\n\n"
          
          # æ·»åŠ  tag messageï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -n "$TAG_MESSAGE" ]; then
            NOTES="${NOTES}${TAG_MESSAGE}\n\n---\n\n"
          fi
          
          # æ·»åŠ ä¸‹è½½è¡¨æ ¼
          NOTES="${NOTES}### ğŸ“¦ ä¸‹è½½\n\n| å¹³å° | æ–‡ä»¶ | è¯´æ˜ |\n|------|------|------|\n"
          
          if [ -f release-files/BovaPlayer-Windows.zip ]; then
            NOTES="${NOTES}| ğŸªŸ Windows | \`BovaPlayer-Windows.zip\` | è§£å‹å³ç”¨ï¼ŒåŒ…å« MPV æ’­æ”¾å¼•æ“ |\n"
          fi
          
          if [ -f release-files/BovaPlayer-macOS.dmg ]; then
            NOTES="${NOTES}| ğŸ macOS | \`BovaPlayer-macOS.dmg\` | æ‰“å¼€ DMGï¼Œæ‹–å…¥ Applications |\n"
          fi
          
          if [ -f release-files/BovaPlayer-Android.apk ]; then
            NOTES="${NOTES}| ğŸ¤– Android | \`BovaPlayer-Android.apk\` | æ”¯æŒæ‰€æœ‰æ¶æ„ï¼ˆarm64/arm/x86ï¼‰ |\n"
          fi
          
          # æ·»åŠ å®‰è£…è¯´æ˜
          NOTES="${NOTES}\n### ğŸ“ å®‰è£…è¯´æ˜\n\n"
          
          if [ -f release-files/BovaPlayer-Android.apk ]; then
            NOTES="${NOTES}**Android:**\n"
            NOTES="${NOTES}1. ä¸‹è½½ \`BovaPlayer-Android.apk\`\n"
            NOTES="${NOTES}2. åœ¨æ‰‹æœºä¸Šå®‰è£…ï¼ˆéœ€è¦å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨ï¼‰\n"
            NOTES="${NOTES}3. æ‰“å¼€åº”ç”¨å³å¯ä½¿ç”¨\n\n"
          fi
          
          if [ -f release-files/BovaPlayer-macOS.dmg ]; then
            NOTES="${NOTES}**macOS:**\n"
            NOTES="${NOTES}1. ä¸‹è½½å¹¶æ‰“å¼€ \`BovaPlayer-macOS.dmg\`\n"
            NOTES="${NOTES}2. å°† BovaPlayer æ‹–å…¥ Applications æ–‡ä»¶å¤¹\n"
            NOTES="${NOTES}3. é¦–æ¬¡æ‰“å¼€å¦‚æç¤º\"å·²æŸå\"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œ:\n"
            NOTES="${NOTES}   \`\`\`bash\n"
            NOTES="${NOTES}   xattr -cr /Applications/BovaPlayer.app\n"
            NOTES="${NOTES}   \`\`\`\n\n"
          fi
          
          if [ -f release-files/BovaPlayer-Windows.zip ]; then
            NOTES="${NOTES}**Windows:**\n"
            NOTES="${NOTES}1. ä¸‹è½½å¹¶è§£å‹ \`BovaPlayer-Windows.zip\`\n"
            NOTES="${NOTES}2. è¿è¡Œ \`BovaPlayer.exe\`\n"
            NOTES="${NOTES}3. æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨\n"
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: BovaPlayer ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: release-files/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
