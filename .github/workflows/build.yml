name: Build All Platforms

on:
  push:
    tags: 
      - 'v*'              # æ‰€æœ‰ v* tag éƒ½ä¼šè§¦å‘
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
    inputs:
      platforms:
        description: 'é€‰æ‹©è¦æž„å»ºçš„å¹³å° (all/windows/macos/android)'
        required: false
        default: 'all'

jobs:
  # ============================================================
  #  Windows æž„å»º (MSYS2 + MPV)
  # ============================================================
  build-windows:
    # åªåœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
    # 1. tag ä¸åŒ…å« -android æˆ– -macos
    # 2. æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† windows æˆ– all
    if: |
      (github.event_name == 'push' && !contains(github.ref, '-android') && !contains(github.ref, '-macos')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows'))
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-mpv
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-rust
            mingw-w64-x86_64-gcc

      - name: Build Windows (MSYS2 çŽ¯å¢ƒ)
        shell: msys2 {0}
        run: |
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:$PKG_CONFIG_PATH"
          cd core
          cargo build --release --bin bova-gui

      - name: æ‰“åŒ… Windows å‘å¸ƒæ–‡ä»¶
        shell: msys2 {0}
        run: |
          mkdir -p release
          cp core/target/release/bova-gui.exe release/BovaPlayer.exe
          # åªå¤åˆ¶éœ€è¦çš„ DLL
          for dll in libmpv-2.dll libavcodec-61.dll libavformat-61.dll libavutil-59.dll \
                     libswscale-8.dll libswresample-5.dll libavfilter-10.dll libavdevice-61.dll \
                     zlib1.dll libgcc_s_seh-1.dll libstdc++-6.dll libwinpthread-1.dll; do
            if [ -f "/mingw64/bin/$dll" ]; then
              cp "/mingw64/bin/$dll" release/
            fi
          done
          # ä¹Ÿå¤åˆ¶ mpv éœ€è¦çš„å…¶ä»–ä¾èµ–
          ldd release/BovaPlayer.exe | grep mingw64 | awk '{print $3}' | while read dep; do
            if [ -f "$dep" ]; then
              cp "$dep" release/ 2>/dev/null || true
            fi
          done
          # æ‰“åŒ… ZIPï¼ˆä½¿ç”¨ PowerShellï¼ŒMSYS2 æ²¡æœ‰ 7zï¼‰

      - name: æ‰“åŒ… ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path release\* -DestinationPath BovaPlayer-Windows.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-Windows
          path: BovaPlayer-Windows.zip

  # ============================================================
  #  macOS æž„å»º (Homebrew MPV)
  # ============================================================
  build-macos:
    # åªåœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
    # 1. tag ä¸åŒ…å« -android æˆ– -windows
    # 2. æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† macos æˆ– all
    if: |
      (github.event_name == 'push' && !contains(github.ref, '-android') && !contains(github.ref, '-windows')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos'))
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          brew install pkg-config mpv

      - name: Build macOS
        run: |
          cd core
          cargo build --release --bin bova-gui

      - name: åˆ›å»º App Bundle
        run: |
          APP_NAME="BovaPlayer"
          APP_DIR="core/target/release/${APP_NAME}.app"
          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"
          mkdir -p "${APP_DIR}/Contents/Frameworks"

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp core/target/release/bova-gui "${APP_DIR}/Contents/MacOS/${APP_NAME}"

          # å¤åˆ¶ MPV åŠ¨æ€åº“åˆ° Frameworks
          MPV_LIB=$(brew --prefix mpv)/lib/libmpv.dylib
          if [ -f "$MPV_LIB" ]; then
            cp "$MPV_LIB" "${APP_DIR}/Contents/Frameworks/"
            install_name_tool -add_rpath "@executable_path/../Frameworks" "${APP_DIR}/Contents/MacOS/${APP_NAME}" 2>/dev/null || true
          fi

          # åˆ›å»º Info.plist
          cat > "${APP_DIR}/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>BovaPlayer</string>
              <key>CFBundleIdentifier</key>
              <string>com.bova.player</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>BovaPlayer</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>0.0.1</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
          </dict>
          </plist>
          PLIST

      - name: åˆ›å»º DMG
        run: |
          hdiutil create -volname "BovaPlayer" \
            -srcfolder core/target/release/BovaPlayer.app \
            -ov -format UDZO \
            BovaPlayer-macOS.dmg

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-macOS
          path: BovaPlayer-macOS.dmg

  # ============================================================
  #  Android æž„å»º (Flutter + Rust FFI)
  # ============================================================
  build-android:
    # åªåœ¨ä»¥ä¸‹æƒ…å†µè¿è¡Œï¼š
    # 1. tag ä¸åŒ…å« -windows æˆ– -macos
    # 2. æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©äº† android æˆ– all
    if: |
      (github.event_name == 'push' && !contains(github.ref, '-windows') && !contains(github.ref, '-macos')) ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'android'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1'
          channel: 'stable'

      - name: Setup Rust (ç”¨äºŽ FFI äº¤å‰ç¼–è¯‘)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: å®‰è£… cargo-ndk
        run: cargo install cargo-ndk

      - name: æž„å»º Rust FFI åº“ (Android)
        run: |
          cd core
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME
          cargo ndk -t arm64-v8a -t armeabi-v7a -t x86_64 -o ../ui/flutter_app/android/app/src/main/jniLibs build --release -p bova-ffi || {
            echo "âš ï¸ Rust FFI äº¤å‰ç¼–è¯‘å¤±è´¥ï¼Œå°†æž„å»ºçº¯ Flutter ç‰ˆæœ¬"
          }

      - name: Flutter ä¾èµ–å®‰è£…
        run: |
          cd ui/flutter_app
          flutter clean
          rm -rf .dart_tool
          rm -rf build
          # ç¡®ä¿ local.properties å­˜åœ¨å¹¶åŒ…å«æ­£ç¡®çš„ Flutter SDK è·¯å¾„
          echo "flutter.sdk=$FLUTTER_ROOT" > android/local.properties
          echo "sdk.dir=$ANDROID_HOME" >> android/local.properties
          # å®‰è£…ä¾èµ–
          flutter pub get
          # æ˜¾ç¤ºå®žé™…å®‰è£…çš„ç‰ˆæœ¬
          echo "=== å·²å®‰è£…çš„ media_kit ç›¸å…³åŒ…ç‰ˆæœ¬ ==="
          flutter pub deps | grep media_kit || true
          
      - name: ä¿®è¡¥ media_kit_video çš„ Android ä»£ç ï¼ˆå¦‚æžœéœ€è¦æ·»åŠ  onSurfaceDestroyed æ–¹æ³•ï¼‰
        run: |
          cd ui/flutter_app
          # æŸ¥æ‰¾ VideoOutput.java æ–‡ä»¶
          VIDEO_OUTPUT_FILE=$(find ~/.pub-cache -name "VideoOutput.java" -path "*/media_kit_video/android/*" | head -1)
          
          if [ -n "$VIDEO_OUTPUT_FILE" ]; then
            echo "æ‰¾åˆ° VideoOutput.java: $VIDEO_OUTPUT_FILE"
            
            # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ onSurfaceDestroyed æ–¹æ³•
            if ! grep -q "onSurfaceDestroyed" "$VIDEO_OUTPUT_FILE"; then
              echo "æ£€æŸ¥æ˜¯å¦éœ€è¦ onSurfaceDestroyed æ–¹æ³•..."
              
              # æ£€æŸ¥æ˜¯å¦å®žçŽ°äº† SurfaceProducer.Callback æŽ¥å£
              if grep -q "SurfaceProducer.Callback" "$VIDEO_OUTPUT_FILE"; then
                echo "éœ€è¦æ·»åŠ  onSurfaceDestroyed æ–¹æ³•..."
                
                # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
                TEMP_FILE=$(mktemp)
                
                # ä½¿ç”¨ awk åœ¨æ–‡ä»¶æœ«å°¾çš„æœ€åŽä¸€ä¸ª } ä¹‹å‰æ’å…¥æ–°æ–¹æ³•
                awk '
                BEGIN { found = 0; }
                /public void onSurfaceChanged/ { found = 1; }
                found && /^  \}$/ && !done {
                  print $0;
                  print "";
                  print "  @Override";
                  print "  public void onSurfaceDestroyed() {";
                  print "    // Surface destroyed, cleanup if needed";
                  print "  }";
                  done = 1;
                  next;
                }
                { print $0; }
                ' "$VIDEO_OUTPUT_FILE" > "$TEMP_FILE"
                
                # æ›¿æ¢åŽŸæ–‡ä»¶
                mv "$TEMP_FILE" "$VIDEO_OUTPUT_FILE"
                
                echo "âœ“ å·²æ·»åŠ  onSurfaceDestroyed æ–¹æ³•"
                echo "=== éªŒè¯ä¿®æ”¹ ==="
                grep -A 3 "onSurfaceDestroyed" "$VIDEO_OUTPUT_FILE" || echo "âš ï¸ éªŒè¯å¤±è´¥"
              else
                echo "âœ“ ä¸éœ€è¦ onSurfaceDestroyed æ–¹æ³•ï¼ˆæœªä½¿ç”¨ SurfaceProducer.Callbackï¼‰"
              fi
            else
              echo "âœ“ onSurfaceDestroyed æ–¹æ³•å·²å­˜åœ¨"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° VideoOutput.java æ–‡ä»¶"
          fi

      - name: æž„å»º APK
        run: |
          cd ui/flutter_app
          flutter build apk --release
          cp build/app/outputs/flutter-apk/app-release.apk ../../BovaPlayer-Android.apk

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-Android
          path: BovaPlayer-Android.apk

  # ============================================================
  #  åˆ›å»º Releaseï¼ˆä»…åœ¨æŽ¨é€ tag æ—¶è§¦å‘ï¼‰
  # ============================================================
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && always()
    needs: [build-windows, build-macos, build-android]
    # å³ä½¿æŸäº› job è¢«è·³è¿‡ä¹Ÿç»§ç»­æ‰§è¡Œ
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          # åªå¤åˆ¶å­˜åœ¨çš„æ–‡ä»¶
          [ -f artifacts/BovaPlayer-Windows/BovaPlayer-Windows.zip ] && cp artifacts/BovaPlayer-Windows/BovaPlayer-Windows.zip release-files/ || echo "âš ï¸ Windows æž„å»ºä¸å­˜åœ¨"
          [ -f artifacts/BovaPlayer-macOS/BovaPlayer-macOS.dmg ] && cp artifacts/BovaPlayer-macOS/BovaPlayer-macOS.dmg release-files/ || echo "âš ï¸ macOS æž„å»ºä¸å­˜åœ¨"
          [ -f artifacts/BovaPlayer-Android/BovaPlayer-Android.apk ] && cp artifacts/BovaPlayer-Android/BovaPlayer-Android.apk release-files/ || echo "âš ï¸ Android æž„å»ºä¸å­˜åœ¨"
          ls -la release-files/
          
      - name: ç”Ÿæˆ Release è¯´æ˜Ž
        id: release_notes
        run: |
          TAG_NAME="${{ github.ref_name }}"
          NOTES="## BovaPlayer ${TAG_NAME}\n\n### ðŸ“¦ ä¸‹è½½\n\n| å¹³å° | æ–‡ä»¶ | è¯´æ˜Ž |\n|------|------|------|\n"
          
          if [ -f release-files/BovaPlayer-Windows.zip ]; then
            NOTES="${NOTES}| ðŸªŸ Windows | \`BovaPlayer-Windows.zip\` | è§£åŽ‹å³ç”¨ï¼ŒåŒ…å« MPV æ’­æ”¾å¼•æ“Ž |\n"
          fi
          
          if [ -f release-files/BovaPlayer-macOS.dmg ]; then
            NOTES="${NOTES}| ðŸŽ macOS | \`BovaPlayer-macOS.dmg\` | æ‰“å¼€ DMGï¼Œæ‹–å…¥ Applications |\n"
          fi
          
          if [ -f release-files/BovaPlayer-Android.apk ]; then
            NOTES="${NOTES}| ðŸ¤– Android | \`BovaPlayer-Android.apk\` | ç›´æŽ¥å®‰è£… APK |\n"
          fi
          
          NOTES="${NOTES}\n> **macOS ç”¨æˆ·æ³¨æ„**: é¦–æ¬¡æ‰“å¼€å¦‚æç¤º\"å·²æŸå\"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œ:\n> \`\`\`bash\n> xattr -cr /Applications/BovaPlayer.app\n> \`\`\`"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: BovaPlayer ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: release-files/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
