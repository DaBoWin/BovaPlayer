name: Build All Platforms

on:
  push:
    tags: [ 'v*' ]          # åªåœ¨æŽ¨é€ tag æ—¶è‡ªåŠ¨æž„å»º + Release
  workflow_dispatch:          # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰

jobs:
  # ============================================================
  #  Windows æž„å»º (MSYS2 + MPV)
  # ============================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-mpv
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-rust
            mingw-w64-x86_64-gcc

      - name: Build Windows (MSYS2 çŽ¯å¢ƒ)
        shell: msys2 {0}
        run: |
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:$PKG_CONFIG_PATH"
          cd core
          cargo build --release --bin bova-gui

      - name: æ‰“åŒ… Windows å‘å¸ƒæ–‡ä»¶
        shell: msys2 {0}
        run: |
          mkdir -p release
          cp core/target/release/bova-gui.exe release/BovaPlayer.exe
          # åªå¤åˆ¶éœ€è¦çš„ DLL
          for dll in libmpv-2.dll libavcodec-61.dll libavformat-61.dll libavutil-59.dll \
                     libswscale-8.dll libswresample-5.dll libavfilter-10.dll libavdevice-61.dll \
                     zlib1.dll libgcc_s_seh-1.dll libstdc++-6.dll libwinpthread-1.dll; do
            if [ -f "/mingw64/bin/$dll" ]; then
              cp "/mingw64/bin/$dll" release/
            fi
          done
          # ä¹Ÿå¤åˆ¶ mpv éœ€è¦çš„å…¶ä»–ä¾èµ–
          ldd release/BovaPlayer.exe | grep mingw64 | awk '{print $3}' | while read dep; do
            if [ -f "$dep" ]; then
              cp "$dep" release/ 2>/dev/null || true
            fi
          done
          # æ‰“åŒ… ZIPï¼ˆä½¿ç”¨ PowerShellï¼ŒMSYS2 æ²¡æœ‰ 7zï¼‰

      - name: æ‰“åŒ… ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path release\* -DestinationPath BovaPlayer-Windows.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-Windows
          path: BovaPlayer-Windows.zip

  # ============================================================
  #  macOS æž„å»º (Homebrew MPV)
  # ============================================================
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          brew install pkg-config mpv

      - name: Build macOS
        run: |
          cd core
          cargo build --release --bin bova-gui

      - name: åˆ›å»º App Bundle
        run: |
          APP_NAME="BovaPlayer"
          APP_DIR="core/target/release/${APP_NAME}.app"
          mkdir -p "${APP_DIR}/Contents/MacOS"
          mkdir -p "${APP_DIR}/Contents/Resources"
          mkdir -p "${APP_DIR}/Contents/Frameworks"

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp core/target/release/bova-gui "${APP_DIR}/Contents/MacOS/${APP_NAME}"

          # å¤åˆ¶ MPV åŠ¨æ€åº“åˆ° Frameworks
          MPV_LIB=$(brew --prefix mpv)/lib/libmpv.dylib
          if [ -f "$MPV_LIB" ]; then
            cp "$MPV_LIB" "${APP_DIR}/Contents/Frameworks/"
            install_name_tool -add_rpath "@executable_path/../Frameworks" "${APP_DIR}/Contents/MacOS/${APP_NAME}" 2>/dev/null || true
          fi

          # åˆ›å»º Info.plist
          cat > "${APP_DIR}/Contents/Info.plist" << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>BovaPlayer</string>
              <key>CFBundleIdentifier</key>
              <string>com.bova.player</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>BovaPlayer</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>0.0.1</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
          </dict>
          </plist>
          PLIST

      - name: åˆ›å»º DMG
        run: |
          hdiutil create -volname "BovaPlayer" \
            -srcfolder core/target/release/BovaPlayer.app \
            -ov -format UDZO \
            BovaPlayer-macOS.dmg

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-macOS
          path: BovaPlayer-macOS.dmg

  # ============================================================
  #  Android æž„å»º (Flutter + Rust FFI)
  # ============================================================
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Setup Rust (ç”¨äºŽ FFI äº¤å‰ç¼–è¯‘)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - name: å®‰è£… cargo-ndk
        run: cargo install cargo-ndk

      - name: æž„å»º Rust FFI åº“ (Android)
        run: |
          cd core
          export ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME
          cargo ndk -t arm64-v8a -t armeabi-v7a -t x86_64 -o ../ui/flutter_app/android/app/src/main/jniLibs build --release -p bova-ffi || {
            echo "âš ï¸ Rust FFI äº¤å‰ç¼–è¯‘å¤±è´¥ï¼Œå°†æž„å»ºçº¯ Flutter ç‰ˆæœ¬"
          }

      - name: Flutter ä¾èµ–å®‰è£…
        run: |
          cd ui/flutter_app
          flutter clean
          flutter pub get

      - name: æž„å»º APK
        run: |
          cd ui/flutter_app
          flutter build apk --release
          cp build/app/outputs/flutter-apk/app-release.apk ../../BovaPlayer-Android.apk

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: BovaPlayer-Android
          path: BovaPlayer-Android.apk

  # ============================================================
  #  åˆ›å»º Releaseï¼ˆä»…åœ¨æŽ¨é€ tag æ—¶è§¦å‘ï¼‰
  # ============================================================
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-windows, build-macos, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          cp artifacts/BovaPlayer-Windows/BovaPlayer-Windows.zip  release-files/
          cp artifacts/BovaPlayer-macOS/BovaPlayer-macOS.dmg      release-files/
          cp artifacts/BovaPlayer-Android/BovaPlayer-Android.apk  release-files/
          ls -la release-files/

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: BovaPlayer ${{ github.ref_name }}
          body: |
            ## BovaPlayer ${{ github.ref_name }}

            ### ðŸ“¦ ä¸‹è½½

            | å¹³å° | æ–‡ä»¶ | è¯´æ˜Ž |
            |------|------|------|
            | ðŸªŸ Windows | `BovaPlayer-Windows.zip` | è§£åŽ‹å³ç”¨ï¼ŒåŒ…å« MPV æ’­æ”¾å¼•æ“Ž |
            | ðŸŽ macOS | `BovaPlayer-macOS.dmg` | æ‰“å¼€ DMGï¼Œæ‹–å…¥ Applications |
            | ðŸ¤– Android | `BovaPlayer-Android.apk` | ç›´æŽ¥å®‰è£… APK |

            > **macOS ç”¨æˆ·æ³¨æ„**: é¦–æ¬¡æ‰“å¼€å¦‚æç¤º"å·²æŸå"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œ:
            > ```bash
            > xattr -cr /Applications/BovaPlayer.app
            > ```
          files: |
            release-files/BovaPlayer-Windows.zip
            release-files/BovaPlayer-macOS.dmg
            release-files/BovaPlayer-Android.apk
          draft: false
          prerelease: false
